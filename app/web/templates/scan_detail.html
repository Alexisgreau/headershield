{% extends 'base.html' %}
{% block content %}
<div class="space-y-6">
  <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <h1 class="text-2xl font-bold">Scan #{{ scan.id }}</h1>
        <p class="text-sm text-slate-600">Cible: <span class="font-mono">{{ target_url }}</span></p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <form method="post" action="/scan">
          <input type="hidden" name="urls" value="{{ target_url }}">
          <button type="submit" class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700">Relancer</button>
        </form>
        <a href="/api/v1/export/csv?scan_id={{scan.id}}" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-medium text-white hover:bg-slate-700">CSV</a>
        <a href="/api/v1/export/pdf?scan_id={{scan.id}}" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-medium text-white hover:bg-slate-700">PDF</a>
      </div>
    </div>

    <div class="mt-5 grid gap-3 sm:grid-cols-3">
      <div class="rounded-xl bg-slate-50 p-4">
        <div class="text-xs uppercase tracking-wide text-slate-500">Score global</div>
        <div class="mt-1 text-3xl font-bold">{{ scan.score_total }}</div>
      </div>
      <div class="rounded-xl bg-slate-50 p-4">
        <div class="text-xs uppercase tracking-wide text-slate-500">Statut</div>
        <div class="mt-2 inline-block rounded-full px-2 py-1 text-xs font-medium {{ 'bg-emerald-100 text-emerald-700' if scan.status=='SUCCESS' else 'bg-amber-100 text-amber-700' if scan.status=='PARTIAL' else 'bg-rose-100 text-rose-700' }}">{{ scan.status }}</div>
      </div>
      <div class="rounded-xl bg-slate-50 p-4">
        <div class="text-xs uppercase tracking-wide text-slate-500">TLS / Redirect</div>
        <div class="mt-1 text-sm text-slate-700">HTTPS: {{ 'Oui' if scan.tls_enforced else 'Non' }}</div>
        <div class="text-sm text-slate-700">HTTP→HTTPS: {{ 'Oui' if scan.http_to_https_redirect else 'Non' }}</div>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <h2 class="mb-3 text-xl font-semibold">Security Headers</h2>
    <div class="space-y-2">
      {% for f in header_findings %}
      <div class="rounded-lg border border-slate-200 p-3">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-mono text-sm font-semibold">{{ f.header_name }}</div>
            <div class="mt-1 break-all text-xs text-slate-600">{{ f.value or '—' }}</div>
          </div>
          <div class="text-right">
            <span class="rounded-full px-2 py-1 text-xs font-medium {{ 'bg-emerald-100 text-emerald-700' if f.status=='OK' else 'bg-amber-100 text-amber-700' if f.status in ['WEAK', 'PRESENT'] else 'bg-slate-100 text-slate-700' if f.status=='INFO' else 'bg-rose-100 text-rose-700' }}">{{ f.status }}</span>
            {% if f.score_impact %}<div class="mt-1 text-xs text-rose-600">-{{ f.score_impact }}</div>{% endif %}
          </div>
        </div>
        {% if f.recommendation %}
        <pre class="mt-2 overflow-x-auto rounded bg-slate-50 p-2 text-xs">{{ f.recommendation }}</pre>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </section>
    {% endfor %}
  </div>

  <h2 class="text-xl font-semibold mt-6 mb-2">HTML Findings</h2>
  <div class="divide-y">
    {% for f in html_findings %}
    <div class="py-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-mono">{{ f.finding_type }}</div>
          <div class="text-gray-600 text-sm">Tag: &lt;{{ f.tag }}&gt;</div>
          <div class="text-gray-600 text-sm">{{ f.details }}</div>
        </div>
        <div>
          <span class="px-2 py-1 rounded bg-purple-100 text-purple-700">-{{ f.score_impact }}</span>
        </div>
      </div>
      {% if f.recommendation %}
      <pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-x-auto">{{ f.recommendation }}</pre>
      {% endif %}
    </div>
    {% endfor %}
    {% if not html_findings %}
      <p class="text-sm text-gray-500">No HTML findings detected.</p>
    {% endif %}
  </div>

  <h2 class="text-xl font-semibold mt-6 mb-2">TLS / Redirects</h2>
  <ul class="list-disc pl-6 text-sm text-gray-700">
    <li>HTTPS available: {{ 'Yes' if scan.tls_enforced else 'No' }}</li>
    <li>HTTP→HTTPS redirect: {{ 'Yes' if scan.http_to_https_redirect else 'No' }}</li>
  </ul>

  <section class="grid gap-6 lg:grid-cols-2">
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="mb-3 text-xl font-semibold">Cookies</h2>
      <div class="space-y-2">
        {% for c in cookie_findings %}
        <div class="rounded-lg border border-slate-200 p-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-mono text-sm font-semibold">{{ c.cookie_name }}</div>
              <div class="text-xs text-slate-600">Secure={{ c.has_secure }} · HttpOnly={{ c.has_httponly }} · SameSite={{ c.samesite }}</div>
            </div>
            <span class="rounded-full px-2 py-1 text-xs font-medium {{ 'bg-emerald-100 text-emerald-700' if c.status=='OK' else 'bg-amber-100 text-amber-700' }}">{{ c.status }}</span>
          </div>
          {% if c.recommendation %}<pre class="mt-2 overflow-x-auto rounded bg-slate-50 p-2 text-xs">{{ c.recommendation }}</pre>{% endif %}
        </div>
        {% endfor %}
        {% if not cookie_findings %}
          <p class="text-sm text-slate-500">Aucun cookie détecté.</p>
        {% endif %}
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="mb-3 text-xl font-semibold">HTML Findings</h2>
      <div class="space-y-2">
        {% for f in html_findings %}
        <div class="rounded-lg border border-slate-200 p-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-mono text-sm font-semibold">{{ f.finding_type }}</div>
              <div class="text-xs text-slate-600">Tag: &lt;{{ f.tag }}&gt;</div>
              <div class="mt-1 text-xs text-slate-600">{{ f.details }}</div>
            </div>
            <span class="rounded-full bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">-{{ f.score_impact }}</span>
          </div>
          {% if f.recommendation %}<pre class="mt-2 overflow-x-auto rounded bg-slate-50 p-2 text-xs">{{ f.recommendation }}</pre>{% endif %}
        </div>
        {% endfor %}
        {% if not html_findings %}
          <p class="text-sm text-slate-500">Aucune anomalie HTML détectée.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <h2 class="mb-3 text-xl font-semibold">Chaînes de redirection</h2>
    <div class="grid gap-4 md:grid-cols-2 text-sm text-slate-700">
      <div class="rounded-lg bg-slate-50 p-3">
        <div class="font-semibold">HTTPS</div>
        {% if raw_meta.get('https') %}
          <div>Status: {{ raw_meta['https'].get('status', '—') }}</div>
          <div>Final URL: {{ raw_meta['https'].get('final_url', '—') }}</div>
          <ol class="mt-2 list-decimal pl-5">
            {% for hop in raw_meta['https'].get('history', []) %}<li class="break-all">{{ hop }}</li>{% endfor %}
            {% if not raw_meta['https'].get('history') %}<li>—</li>{% endif %}
          </ol>
        {% else %}<div>Aucune donnée HTTPS.</div>{% endif %}
      </div>

      <div class="rounded-lg bg-slate-50 p-3">
        <div class="font-semibold">HTTP</div>
        {% if raw_meta.get('http') %}
          <div>Status: {{ raw_meta['http'].get('status', '—') }}</div>
          <div>Final URL: {{ raw_meta['http'].get('final_url', '—') }}</div>
          <ol class="mt-2 list-decimal pl-5">
            {% for hop in raw_meta['http'].get('history', []) %}<li class="break-all">{{ hop }}</li>{% endfor %}
            {% if not raw_meta['http'].get('history') %}<li>—</li>{% endif %}
          </ol>
        {% else %}<div>Aucune donnée HTTP.</div>{% endif %}
      </div>
    </div>
  </section>
</div>
{% endblock %}
